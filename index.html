<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<link rel="stylesheet" type="text/css" href="style.css">
<title>Face Detector</title>
</head>
<body>
<script src="webcam.js"></script>

    <div id="my_camera" style="width:320px; height:240px;"></div>
    <div id="my_result"></div>

    <script language="JavaScript">
        Webcam.attach( '#my_camera' );

        function take_snapshot() {
            Webcam.snap( function(data_uri) {
                document.getElementById('my_result').innerHTML = '<img src="'+data_uri+'"/>';
            } );
        }
    </script>

    <a href="javascript:void(take_snapshot())">Take Snapshot</a>
<div id="container">
	<div id="header"><div class="title">Javascript Face Detector</div><div class="subtitle">This tool identifies human faces in a photograph</div></div>
    <div id="content">
        <div id="input">
            <div id="urlbox"><div id="urlbox-row"><div id="url-text"><input type="text" id="url-image" placeholder="Paste image URL here"/></div><div id="url-btn"><input id="url-submit" type="button" value="Submit"/></div></div></div>
            <div id="image-viewer"><div id="image-help">Drag and drop image<br/>OR<br/>Click to upload</div><input type="file" id="file-selector" accept="image/*"/><canvas id="image-out"/></div>
        </div>
        <div id="output">
            <div id="stats"><span id="loading"></span>Detected <span id="num-faces">[?] faces</span> in <span id="detection-time">[?]</span> ms</div>
            <div id="results-viewer"/></div>
        </div>
    </div>
    <div id="footer"><div>Karen Ouyang, Hansen Qian, and Yicheng Sun<br/>Source code: <a href="https://github.com/Hansenq/face-emoticon" target="_blank">Github</a><br/><a href="http://princeton.edu/" target="_blank" onmouseover="this.style.color='orange';" onmouseout="this.style.color='';">Princeton University</a> | <a href="http://vision.princeton.edu/courses/COS429/2014fa/" target="_blank">COS 429 Fall 2014</a></div></div>
<script type="text/javascript" src="ccv.js"></script>
<script type="text/javascript" src="face.js"></script>
<script type="text/javascript">
agent = (function( ua ) {
	ua = ua.toLowerCase();

	rwebkit = /(webkit)[ \/]([\w.]+)/;
	ropera = /(opera)(?:.*version)?[ \/]([\w.]+)/;
	rmsie = /(msie) ([\w.]+)/;
	rmozilla = /(mozilla)(?:.*? rv:([\w.]+))?/;

	var match = rwebkit.exec( ua ) ||
				ropera.exec( ua ) ||
				rmsie.exec( ua ) ||
				ua.indexOf("compatible") < 0 && rmozilla.exec( ua ) ||
				[];

	return { browser: match[1] || "", version: match[2] || "0" };
})(navigator.userAgent);

var async = false;

function getImageDim(image) {
	var result = {};
	document.body.appendChild(image);
	result['width'] = image.offsetWidth;
	result['height'] = image.offsetHeight;
	document.body.removeChild(image);
	return result;
}

function detectNewImage(src, async) {
    document.getElementById("loading").innerHTML = "(Loading...) ";
    document.getElementById("detection-time").innerHTML = "[...]";
    document.getElementById("num-faces").innerHTML = "[?] faces";
	var image = new Image();
	var canvas_image = document.getElementById("image-out");
	var ctx = canvas_image.getContext("2d");
	image.onload = function () {
		/* load image, and draw it to canvas */
        document.getElementById("loading").innerHTML = "";
        document.getElementById("detection-time").innerHTML = "[...]";
		var dim = getImageDim(image);
		var boundingWidth = document.getElementById("urlbox").offsetWidth - 2;
		var boundingHeight = window.innerHeight - (document.getElementById("header").offsetHeight + document.getElementById("footer").offsetHeight) - 120;
		var image_viewer = document.getElementById("image-viewer");
        var results_viewer = document.getElementById("results-viewer");
        results_viewer.innerHTML = "";
		var newWidth = dim.width, newHeight = dim.height, scale = 1;
		if (dim.width * boundingHeight > boundingWidth * dim.height) {
			newWidth = boundingWidth;
			newHeight = boundingWidth * dim.height / dim.width;
			scale = newWidth / dim.width;
		} else {
			newHeight = boundingHeight;
			newWidth = boundingHeight * dim.width / dim.height;
			scale = newHeight / dim.height;
		}
		image_viewer.style.width = newWidth.toString() + "px";
		image_viewer.style.height = newHeight.toString() + "px";
		results_viewer.style.height = newHeight.toString() + "px";
		canvas_image.width = newWidth;
		canvas_image.style.width = newWidth.toString() + "px";
		canvas_image.height = newHeight;
		canvas_image.style.height = newHeight.toString() + "px";
		ctx.drawImage(image, 0, 0, newWidth, newHeight);
        elapsed_time = (new Date()).getTime();
		function post(comp) {
            document.getElementById("detection-time").innerHTML = Math.round((new Date()).getTime() - elapsed_time).toString();
			document.getElementById("num-faces").innerHTML = comp.length.toString() + " face" + (comp.length == 1 ? "" : "s");
			ctx.lineWidth = 2;
			ctx.strokeStyle = 'rgba(255,165,0,0.8)';
			/* draw detected area */
			for (var i = 0; i < comp.length; i++) {
                var canvas = document.createElement("canvas");
                canvas.width = 144;
                canvas.height = 184;
                canvas.getContext("2d").drawImage(image, comp[i].x, comp[i].y, comp[i].width, comp[i].height, 0, 0, 144, 184);
                var img = document.createElement("img");
                img.src = canvas.toDataURL("image/png");
                img.className = "thumbnail";
                if (results_viewer.firstChild) results_viewer.insertBefore(img, results_viewer.firstChild);
                else results_viewer.appendChild(img);

                ctx.beginPath();
                ctx.rect(comp[i].x * scale, comp[i].y * scale, comp[i].width * scale, comp[i].height * scale);
				ctx.stroke();
            }
		}
		/* call main detect_objects function */
		if (async) {
			ccv.detect_objects({ "canvas" : ccv.grayscale(ccv.pre(image)),
								 "cascade" : cascade,
								 "interval" : 5,
								 "min_neighbors" : 1,
								 "async" : true,
								 "worker" : 1 })(post);
		} else {
			var comp = ccv.detect_objects({ "canvas" : ccv.grayscale(ccv.pre(image)),
											"cascade" : cascade,
											"interval" : 5,
											"min_neighbors" : 1 });
			post(comp);
		}
	};
	image.src = src;
}

function handleLocalFile(file) {
	if (file.type.match(/image.*/)) {
		var reader = new FileReader();
		reader.onload = function (e) {
			detectNewImage(e.target.result, async);
		};
		reader.readAsDataURL(file);
	}
}

document.getElementById("image-viewer").addEventListener("dragover", function (e) {
	e.stopPropagation();
	e.preventDefault();
	document.getElementById("image-help").style.zIndex = "1";
}, false);

if (agent.browser == "mozilla") {
	document.getElementById("file-selector").style.display = "none";
	document.getElementById("file-selector").addEventListener("click", function (e) {
		e.stopPropagation();
		e.preventDefault();
	}, false);
	document.getElementById("image-viewer").addEventListener("click", function (e) {
		e.stopPropagation();
		e.preventDefault();
		document.getElementById("file-selector").click();
	}, false);
}

document.getElementById("image-viewer").addEventListener("mouseover", function (e) {
	document.getElementById("image-help").style.zIndex = "1";
});

document.getElementById("image-viewer").addEventListener("mouseout", function (e) {
	document.getElementById("image-help").style.zIndex = "0";
});

document.getElementById("file-selector").addEventListener("change", function (e) {
	var files = this.files;
	if (files.length)
		handleLocalFile(files[0]);
});

document.getElementById("image-viewer").addEventListener("drop", function (e) {
	e.stopPropagation();
	e.preventDefault();

	var files = e.dataTransfer.files;

	if (files.length)
		handleLocalFile(files[0]);

	document.getElementById("image-help").style.zIndex = "0";
}, false);

document.getElementById("url-submit").addEventListener("click", function(e) {
	var url = document.getElementById("url-image").value;
	if (url.length > 0) {
        var img = new Image;
        img.crossOrigin = "anonymous";
        img.src = url;
        detectNewImage(url, async);
		//window.location.hash = "#" + encodeURIComponent(url);
		//detectNewImage("loader.php?src=" + encodeURIComponent((url.substr(0, 7).toLowerCase() == "http://") ? url : "http://" + url), async);
	}
});
</script>

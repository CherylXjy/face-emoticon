<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <link rel="stylesheet" type="text/css" href="style.css" />
    <title>Face Detector</title>
</head>
<body>
<div id="container">
	<div id="header">
        <div class="title">Javascript Face Detector</div><div class="subtitle">This tool identifies human faces in a photograph</div></div>
    <div id="content">
        <div id="input">
            <div id="urlbox">
                <div id="urlbox-row">
                    <div id="url-text">
                        <input type="text" id="url-image" placeholder="Paste image URL here" />
                        <div id="url-btn">
                            <input id="url-submit" type="button" value="Submit"/>
                        </div>
                    </div>
                </div>
            </div>
            <div id="image-viewer">
                <div id="image-help">
                    Drag and drop image<br/>OR<br/>Click to upload
                </div>
                <input type="file" id="file-selector" accept="image/*" />
                <canvas id="image-out"></canvas>
            </div>
        </div>
        <div id="output">
            <div id="stats">
                <span id="loading"></span>
                Detected <span id="num-faces">[?] faces</span> in <span id="detection-time">[?]</span> ms
            </div>
            <div id="results-viewer"></div>
        </div>
    </div>
    <div id="footer">
        <div>
            Karen Ouyang, Hansen Qian, and Yicheng Sun<br/>
            Source code: <a href="https://github.com/Hansenq/face-emoticon" target="_blank">Github</a><br/><a href="http://princeton.edu/" target="_blank" onmouseover="this.style.color='orange';" onmouseout="this.style.color='';">Princeton University</a> | <a href="http://vision.princeton.edu/courses/COS429/2014fa/" target="_blank">COS 429 Fall 2014</a>
        </div>
    </div>
</div>
</body>



<script src="../convnetjs/demo/jquery-1.8.3.min.js"></script>
<script src="../convnetjs/build/vis.js"></script>
<script src="../convnetjs/build/util.js"></script>
<script src="../convnetjs/build/convnet.js"></script>

<!-- feature detection libraries -->
<script src="..clmtrackr/js/utils.js"></script>
<script src="..clmtrackr/js/clmtrackr.js"></script>
<script src="..clmtrackr/js/Filesaver.min.js"></script>
<script src="..clmtrackr/models/model_pca_20_svm.js"></script>

<script type="text/javascript" src="ccv.js"></script>
<script type="text/javascript" src="face.js"></script>

<script type="text/javascript" src="./emotion_model_conv1.json"></script>

<script type="text/javascript">
    agent = (function( ua ) {
    	ua = ua.toLowerCase();

    	rwebkit = /(webkit)[ \/]([\w.]+)/;
    	ropera = /(opera)(?:.*version)?[ \/]([\w.]+)/;
    	rmsie = /(msie) ([\w.]+)/;
    	rmozilla = /(mozilla)(?:.*? rv:([\w.]+))?/;

    	var match = rwebkit.exec( ua ) ||
    				ropera.exec( ua ) ||
    				rmsie.exec( ua ) ||
    				ua.indexOf("compatible") < 0 && rmozilla.exec( ua ) ||
    				[];

    	return { browser: match[1] || "", version: match[2] || "0" };
    })(navigator.userAgent);

    var async = false;

    function getImageDim(image) {
    	var result = {};
    	document.body.appendChild(image);
    	result['width'] = image.offsetWidth;
    	result['height'] = image.offsetHeight;
    	document.body.removeChild(image);
    	return result;
    }

    function detectNewImage(src, async) {
        document.getElementById("loading").innerHTML = "(Loading...) ";
        document.getElementById("detection-time").innerHTML = "[...]";
        document.getElementById("num-faces").innerHTML = "[?] faces";
    	var image = new Image();
    	var canvas_image = document.getElementById("image-out");
    	var ctx = canvas_image.getContext("2d");
    	image.onload = function () {
    		/* load image, and draw it to canvas */
            document.getElementById("loading").innerHTML = "";
            document.getElementById("detection-time").innerHTML = "[...]";
    		var dim = getImageDim(image);
    		var boundingWidth = document.getElementById("urlbox").offsetWidth - 2;
    		var boundingHeight = window.innerHeight - (document.getElementById("header").offsetHeight + document.getElementById("footer").offsetHeight) - 120;
    		var image_viewer = document.getElementById("image-viewer");
            var results_viewer = document.getElementById("results-viewer");
            results_viewer.innerHTML = "";
    		var newWidth = dim.width, newHeight = dim.height, scale = 1;
    		if (dim.width * boundingHeight > boundingWidth * dim.height) {
    			newWidth = boundingWidth;
    			newHeight = boundingWidth * dim.height / dim.width;
    			scale = newWidth / dim.width;
    		} else {
    			newHeight = boundingHeight;
    			newWidth = boundingHeight * dim.width / dim.height;
    			scale = newHeight / dim.height;
    		}
    		image_viewer.style.width = newWidth.toString() + "px";
    		image_viewer.style.height = newHeight.toString() + "px";
    		results_viewer.style.height = newHeight.toString() + "px";
    		canvas_image.width = newWidth;
    		canvas_image.style.width = newWidth.toString() + "px";
    		canvas_image.height = newHeight;
    		canvas_image.style.height = newHeight.toString() + "px";
    		ctx.drawImage(image, 0, 0, newWidth, newHeight);
            elapsed_time = (new Date()).getTime();
    		function post(comp) {
                document.getElementById("detection-time").innerHTML = Math.round((new Date()).getTime() - elapsed_time).toString();
    			document.getElementById("num-faces").innerHTML = comp.length.toString() + " face" + (comp.length == 1 ? "" : "s");
    			ctx.lineWidth = 2;
    			ctx.strokeStyle = 'rgba(255,165,0,0.8)';
    			/* draw detected area */
    			for (var i = 0; i < comp.length; i++) {
                    var canvas = document.createElement("canvas");
                    canvas.id = "canvas" + i;
                    canvas.width = 256;
                    canvas.height = 256;
                    canvas.getContext("2d").drawImage(image, comp[i].x, comp[i].y, comp[i].width, comp[i].height, 0, 0, 256, 256);
                    var img = document.createElement("img");
                    img.id = "image" + i;
                    img.src = canvas.toDataURL("image/png");
                    img.className = "thumbnail";
                    img.width = 144;
                    img.height = 144;
                    results_viewer.appendChild(img);

                    ctx.beginPath();
                    ctx.rect(comp[i].x * scale, comp[i].y * scale, comp[i].width * scale, comp[i].height * scale);
    				ctx.stroke();
                }
    		}
    		/* call main detect_objects function */
    		if (async) {
    			ccv.detect_objects({ "canvas" : ccv.grayscale(ccv.pre(image)),
    								 "cascade" : cascade,
    								 "interval" : 5,
    								 "min_neighbors" : 1,
    								 "async" : true,
    								 "worker" : 1 })(post);
    		} else {
    			var comp = ccv.detect_objects({ "canvas" : ccv.grayscale(ccv.pre(image)),
    											"cascade" : cascade,
    											"interval" : 5,
    											"min_neighbors" : 1 });
    			post(comp);
    		}
    	};
    	image.src = src;
    }

    function handleLocalFile(file) {
    	if (file.type.match(/image.*/)) {
    		var reader = new FileReader();
    		reader.onload = function (e) {
    			detectNewImage(e.target.result, async);
    		};
    		reader.readAsDataURL(file);
    	}
    }

    // Emotion Classification Neural Net

    var test_feature = [
        [65.97685946671847, 125.26988451562892],
        [64.82365610396955, 146.02410464548907],
        [67.88010615154408, 166.62815040808115],
        [72.86202454668572, 187.46390582222887],
        [81.82746353031213, 204.2876019527919],
        [93.96433121187687, 217.8544359674869],
        [108.42585528035389, 228.42563578573487],
        [125.68861259826808, 232.0367468600619],
        [143.34209671400646, 228.71148266898962],
        [158.86977802931347, 218.31984938378358],
        [172.07465759799953, 205.02433586900457],
        [181.9888903798277, 188.36074898949676],
        [187.82894219709186, 167.65562632257306],
        [191.38217515298604, 146.90900126594937],
        [190.70215754295822, 125.92884819448962],
        [177.9999809723255, 115.17486340065254],
        [167.93201704751763, 111.18179122016815],
        [153.50504275719646, 112.40941849275809],
        [141.90720991745422, 115.3418491988302],
        [78.63362172495702, 115.11147312015059],
        [88.68278885982681, 111.18727968117514],
        [103.04617740149848, 112.43726154588242],
        [114.62704304110943, 115.40353588820516],
        [86.68466495067089, 129.79445094483333],
        [98.31325445597501, 124.96060711960979],
        [110.86965519135117, 130.81827580991188],
        [98.21415343545726, 133.7807856202561],
        [98.79849902421762, 128.7964634205092],
        [169.26829000194317, 129.91455324585934],
        [157.64452110802648, 124.99720008632474],
        [145.10245621378027, 130.89576173285306],
        [157.8431846261169, 133.8957004907946],
        [157.4032933368578, 128.84883302044898],
        [127.92700709878389, 127.23668764831126],
        [114.05699438111547, 157.50045937829117],
        [109.28949148891255, 166.44511940565397],
        [114.14682512496191, 172.78759153331225],
        [127.22847534970555, 175.77969386510057],
        [140.4012438502372, 172.9300240211282],
        [145.37269090684185, 166.73372483836],
        [140.59855507368866, 157.67538094085353],
        [127.52380246587776, 147.4669016722755],
        [117.45821090218277, 169.84150473039895],
        [136.8988173827686, 169.87017537837488],
        [104.10116005909488, 192.82258940500856],
        [111.9989471283036, 188.08246963547617],
        [120.60801596183268, 186.3842794991788],
        [126.57351235460989, 187.72702988816104],
        [132.6153751075646, 186.4375145396665],
        [141.07347408625202, 188.24590195733524],
        [148.98158902462666, 192.96333834041712],
        [142.79200596368298, 198.653819930925],
        [135.58551816297106, 202.4665950817519],
        [126.15332910069654, 203.73800698705156],
        [116.8243251282221, 202.50562520832096],
        [109.70904047319637, 198.55663532920784],
        [115.50271750096913, 193.62633459929043],
        [126.2547863260057, 194.83814266596374],
        [137.11243196478762, 193.57357704464647],
        [137.42382574573384, 192.18479068648446],
        [126.45571626519302, 192.59665512391393],
        [115.64368611528646, 192.07774707713583],
        [127.18252268930401, 166.49901119688906],
        [91.52368676529669, 126.29133631060218],
        [105.63929624790882, 126.39804491138932],
        [104.76777055606297, 132.74071173846028],
        [91.73820575060877, 132.55249387390825],
        [164.48086540010235, 126.34082970346577],
        [150.29624467329018, 126.50201410778487],
        [151.2141970940486, 132.8333744226135],
        [164.2567668045946, 132.68172187774053]];

    var net;
    function start() {
        var layer_defs_conv = [];
        // Define layers here:
        layer_defs_conv.push({type:'input', out_sx:2, out_sy:1, out_depth:71});
        layer_defs_conv.push({type:'conv', sx:10, filters:8, stride:1, pad:2, activation:'relu'});
        layer_defs_conv.push({type:'pool', sx:2, stride:2});
        layer_defs_conv.push({type:'conv', sx:10, filters:16, stride:1, pad:2, activation:'relu'});
        layer_defs_conv.push({type:'pool', sx:3, stride:3});
        layer_defs_conv.push({type:'softmax', num_classes:6});
        // Define layers above

        var json = JSON.parse(json_string);
        net = new convnetjs.Net();
        net.fromJSON(json);
    }
    start();

    function classifyEmotionNN(features) {
        width = [];
        height = [];
        for (var i = 0; i < features.length; i++) {
          width.push(features[i][0]);
          height.push(features[i][1]);
        }
        min = [];
        min[0] = Math.min.apply(Math, width);
        min[1] = Math.min.apply(Math, height);
        size = [];
        size[0] = Math.max.apply(Math, width) - min[0];
        size[1] = Math.max.apply(Math, height) - min[1];

        var vol = new convnetjs.Vol(2, 1, 71, 0.0);

        for (var ix = 0; ix < 71; ix++) {
            vol.set(0, 0, ix, (features[ix][0] - min[0]) / size[0]);
            vol.set(1, 0, ix, (features[ix][1] - min[1]) / size[1]);
        }

        var output = net.forward(vol);
        console.log(output);
        return output;
    }
    classifyEmotionNN(test_feature);

    document.getElementById("image-viewer").addEventListener("dragover", function (e) {
    	e.stopPropagation();
    	e.preventDefault();
    	document.getElementById("image-help").style.zIndex = "1";
    }, false);

    if (agent.browser == "mozilla") {
    	document.getElementById("file-selector").style.display = "none";
    	document.getElementById("file-selector").addEventListener("click", function (e) {
    		e.stopPropagation();
    		e.preventDefault();
    	}, false);
    	document.getElementById("image-viewer").addEventListener("click", function (e) {
    		e.stopPropagation();
    		e.preventDefault();
    		document.getElementById("file-selector").click();
    	}, false);
    }

    document.getElementById("image-viewer").addEventListener("mouseover", function (e) {
    	document.getElementById("image-help").style.zIndex = "1";
    });

    document.getElementById("image-viewer").addEventListener("mouseout", function (e) {
    	document.getElementById("image-help").style.zIndex = "0";
    });

    document.getElementById("file-selector").addEventListener("change", function (e) {
    	var files = this.files;
    	if (files.length)
    		handleLocalFile(files[0]);
    });

    document.getElementById("image-viewer").addEventListener("drop", function (e) {
    	e.stopPropagation();
    	e.preventDefault();

    	var files = e.dataTransfer.files;

    	if (files.length)
    		handleLocalFile(files[0]);

    	document.getElementById("image-help").style.zIndex = "0";
    }, false);

    document.getElementById("url-submit").addEventListener("click", function(e) {
    	var url = document.getElementById("url-image").value;
    	if (url.length > 0) {
    		window.location.hash = "#" + encodeURIComponent(url);
    		detectNewImage("loader.php?src=" + encodeURIComponent((url.substr(0, 7).toLowerCase() == "http://") ? url : "http://" + url), async);
    	}
    });
</script>
</html>